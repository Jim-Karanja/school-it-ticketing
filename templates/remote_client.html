<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remote Desktop Client - School IT Support</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
        }

        .header {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            margin-bottom: 2rem;
            text-align: center;
            max-width: 600px;
            width: 100%;
        }

        .header h1 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 2rem;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .connection-card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            max-width: 800px;
            width: 100%;
            margin-bottom: 2rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 1.1rem;
        }

        .status-connecting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .instructions {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .instructions h3 {
            color: #495057;
            margin-bottom: 1rem;
        }

        .instructions ol {
            color: #666;
            line-height: 1.6;
            padding-left: 1.5rem;
        }

        .instructions li {
            margin-bottom: 0.5rem;
        }

        .permission-request {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 2rem;
        }

        .permission-request h4 {
            color: #1976d2;
            margin-bottom: 1rem;
        }

        .permission-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-success {
            background: #28a745;
            color: white;
            font-size: 1.2rem;
            padding: 1rem 2.5rem;
        }

        .btn-success:hover {
            background: #218838;
        }

        .connection-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            margin-top: auto;
            padding: 1rem;
            text-align: center;
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
        }

        .hidden {
            display: none;
        }

        #screenShareVideo {
            width: 100%;
            max-width: 100%;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: #000;
        }

        .controls {
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üñ•Ô∏è Remote IT Support</h1>
        <p>You're about to start a remote support session. Our IT team will be able to see and control your desktop to help resolve your issue.</p>
    </div>

    <div class="connection-card">
        <div id="status-indicator" class="status-indicator status-connecting">
            <div class="spinner"></div>
            Connecting to support session...
        </div>

        <div id="permission-request" class="permission-request">
            <h4>üîí Screen Sharing Permission Required</h4>
            <p>To start the remote support session, we need permission to access your screen. This allows our IT staff to see your desktop and help resolve your issue.</p>
            <div class="permission-buttons">
                <button onclick="startScreenShare()" class="btn btn-success">Allow Screen Sharing</button>
                <button onclick="cancelSession()" class="btn btn-secondary">Cancel</button>
            </div>
        </div>

        <div id="connection-info" class="connection-info hidden">
            <strong>Session ID:</strong> {{ session.session_id }}<br>
            <strong>IT Staff:</strong> {{ session.it_staff_name }}<br>
            <strong>Status:</strong> <span id="session-status">{{ session.status.title() }}</span>
        </div>

        <div id="screen-share-container" class="hidden">
            <h3>Screen Sharing Active</h3>
            <p>Your screen is now being shared with our IT support team. They can see your desktop and will be able to control your mouse and keyboard to help resolve your issue.</p>
            
            <video id="screenShareVideo" autoplay muted></video>
            
            <div class="controls">
                <button onclick="stopScreenShare()" class="btn btn-secondary">Stop Sharing</button>
                <button onclick="toggleMute()" class="btn btn-secondary" id="muteBtn">Disable Audio</button>
            </div>
        </div>

        <div class="instructions">
            <h3>What happens next?</h3>
            <ol>
                <li>Click "Allow Screen Sharing" to start the session</li>
                <li>Our IT staff will be able to see your screen</li>
                <li>They can control your mouse and keyboard to fix the issue</li>
                <li>You can stop sharing at any time by clicking "Stop Sharing"</li>
                <li>The session will end automatically when the issue is resolved</li>
            </ol>
        </div>
    </div>

    <div class="footer">
        <p>üîí Your privacy and security are important to us. The remote session is encrypted and will only last as long as needed to resolve your IT issue.</p>
    </div>

    <script>
        const socket = io();
        let screenStream = null;
        let audioMuted = false;
        
        const sessionId = '{{ session.session_id }}';
        const userToken = '{{ session.user_token }}';

        // Initialize connection
        socket.on('connect', function() {
            console.log('Connected to support server');
            
            // Join the remote session
            socket.emit('join_session', {
                session_id: sessionId,
                token: userToken,
                type: 'user'
            });
        });

        // Handle session joined
        socket.on('session_joined', function(data) {
            console.log('Joined session:', data);
            updateStatus('connected', 'Connected to support session');
        });

        // Handle IT staff connection
        socket.on('it_staff_connected', function(data) {
            console.log('IT staff connected');
            updateStatus('connected', '‚úÖ IT staff is ready to help');
        });

        // Handle errors
        socket.on('error', function(data) {
            console.error('Session error:', data);
            updateStatus('error', 'Connection error: ' + data.message);
        });

        // Handle disconnect
        socket.on('disconnect', function() {
            console.log('Disconnected from support server');
            updateStatus('error', 'Disconnected from support session');
        });

        function updateStatus(type, message) {
            const indicator = document.getElementById('status-indicator');
            indicator.className = `status-indicator status-${type}`;
            
            if (type === 'connecting') {
                indicator.innerHTML = `<div class="spinner"></div>${message}`;
            } else if (type === 'connected') {
                indicator.innerHTML = `‚úÖ ${message}`;
            } else if (type === 'error') {
                indicator.innerHTML = `‚ùå ${message}`;
            }
        }

        async function startScreenShare() {
            try {
                updateStatus('connecting', 'Starting screen share...');
                
                // Request screen sharing permission
                screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        cursor: "always",
                        resizeMode: "crop-and-scale"
                    },
                    audio: true
                });

                // Show the video locally (for user feedback)
                const video = document.getElementById('screenShareVideo');
                video.srcObject = screenStream;

                // Hide permission request, show screen share
                document.getElementById('permission-request').classList.add('hidden');
                document.getElementById('screen-share-container').classList.remove('hidden');
                document.getElementById('connection-info').classList.remove('hidden');

                updateStatus('connected', 'üñ•Ô∏è Screen sharing active - IT staff can now see your screen');

                // Handle stream end
                screenStream.getVideoTracks()[0].onended = function() {
                    stopScreenShare();
                };

                console.log('Screen sharing started successfully');

            } catch (error) {
                console.error('Failed to start screen sharing:', error);
                updateStatus('error', 'Failed to start screen sharing. Please try again.');
            }
        }

        function stopScreenShare() {
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }

            document.getElementById('screen-share-container').classList.add('hidden');
            document.getElementById('permission-request').classList.remove('hidden');
            document.getElementById('connection-info').classList.add('hidden');

            updateStatus('connecting', 'Screen sharing stopped. Click "Allow Screen Sharing" to resume.');
        }

        function toggleMute() {
            if (screenStream) {
                const audioTracks = screenStream.getAudioTracks();
                if (audioTracks.length > 0) {
                    audioMuted = !audioMuted;
                    audioTracks[0].enabled = !audioMuted;
                    
                    const btn = document.getElementById('muteBtn');
                    btn.textContent = audioMuted ? 'Enable Audio' : 'Disable Audio';
                }
            }
        }

        function cancelSession() {
            if (confirm('Are you sure you want to cancel the remote support session?')) {
                window.close();
            }
        }

        // Update session status periodically
        setInterval(function() {
            fetch('/api/remote_sessions')
                .then(response => response.json())
                .then(data => {
                    const sessionInfo = data.sessions.find(s => s.session_id === sessionId);
                    if (sessionInfo) {
                        document.getElementById('session-status').textContent = sessionInfo.status.charAt(0).toUpperCase() + sessionInfo.status.slice(1);
                    }
                })
                .catch(error => console.log('Status update failed:', error));
        }, 10000);
    </script>
</body>
</html>
